<!-- Visualize sentiments of tweets from universities in Melbourne -->
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Visualizing Twitter users' sentiments in Melbourne</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<div id='map'></div>

<script>
let melb_uni_url = "http://115.146.93.170:5984/tweet_all10gb/_design/melb_uni/_view/new-view?&reduce=false"
let rmit_url = "http://115.146.93.170:5984/tweet_all10gb/_design/rmit/_view/new-view?&reduce=false"
let monash_uni_url = "http://115.146.93.170:5984/tweet_all10gb/_design/monash_uni/_view/new-view?&reduce=false"
let monash_caulfield_url = "http://115.146.93.170:5984/tweet_all10gb/_design/monash_caulfield/_view/new-view?&reduce=false"
let swinburne_url = "http://115.146.93.170:5984/tweet_all10gb/_design/swinburne_uni/_view/new-view?&reduce=false"
let vic_uni_url = "http://115.146.93.170:5984/tweet_all10gb/_design/vic_uni/_view/new-view?&reduce=false"
let latrobe_uni_url = "http://115.146.93.170:5984/tweet_all10gb/_design/latrobe_uni/_view/new-view?&reduce=false"
let deakin_uni_url = "http://115.146.93.170:5984/tweet_all10gb/_design/deakin_uni/_view/new-view?&reduce=false"

// source: http://htmlcolorcodes.com/color-chart/
var sentimentList = [
    [-1, '#b71c1c'],
    [-0.75, '#d32f2f'],
    [-0.5, '#f44336'],
    [-0.25, '#e57373'],
   //[0, '#b3e5fc'],
    [0.25, '#4fc3f7'],
    [0.5,'#03a9f4'],
    [0.75,'#0288d1'],
    [1,'#01579b' ]
];

// Views:
// for_visualization: any tweet has point coordinates and polarity
// community-langs: any tweet has an assigned community_lang

 $.get(rmit_url, function(rmit_data){
	$.get(monash_uni_url, function(monash_data){
		$.get(monash_caulfield_url, function(monash_caulfield_data){
			$.get(swinburne_url, function(swinburne_data){
				$.get(vic_uni_url, function(vic_uni_data){
					$.get(latrobe_uni_url, function(latrobe_uni_data){
						$.get(deakin_uni_url, function(deakin_uni_data){
							$.get(melb_uni_url, function(melb_uni_data){
								console.log(rmit_data);
								console.log(monash_data);
								console.log(monash_caulfield_data);
								console.log(swinburne_data);
								console.log(vic_uni_data);
								console.log(latrobe_uni_data);
							    console.log(deakin_uni_data);
							    console.log(melb_uni_data);

							    // access token to mapbox
							    mapboxgl.accessToken = 'pk.eyJ1IjoiYmRhbmcxIiwiYSI6ImNqMmVzOTl1bzA3c2oycWx2bXQ5d3BkYW0ifQ.eMCcDItwOxuOwjazCFCyZQ';

							    // Define a map
							    var map = new mapboxgl.Map({
							        container: 'map', // container id
							        style: 'mapbox://styles/mapbox/light-v9', //stylesheet location
							        center: [144.98, -37.79], // starting position
							        // pitch: 85,
							        bearing: 5,
							        zoom: 11.5 // starting zoom
							    });

							    // Add zoom and rotation controls to the map.
							    map.addControl(new mapboxgl.NavigationControl());

							    // Add FullScreen view
							    map.addControl(new mapboxgl.FullscreenControl());



//////////////////////////////////////////////////////////////////////////////////
							    // layer 1: Unimelb
							    let featureList_unimelb = []
							    melb_uni_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_unimelb.push(feature)
							    });
							    let geoJson_unimelb = {
							        "type": "FeatureCollection",
							        "features": featureList_unimelb
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "unimelb_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_unimelb,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
								// Layer 2: RMIT
							    let featureList_rmit = []
							    rmit_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_rmit.push(feature)
							    });

							    let geoJson_rmit = {
							        "type": "FeatureCollection",
							        "features": featureList_rmit
							    }

							    // plotting GeoJSON points on maps
							    map.on('load', function () {

							        map.addLayer({
							            "id": "rmit_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_rmit,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });

							    });
//////////////////////////////////////////////////////////////////////////////////
								// layer 3: Monash Uni
								let featureList_monash = []
							    monash_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_monash.push(feature)
							    });
							    let geoJson_monash = {
							        "type": "FeatureCollection",
							        "features": featureList_monash
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "monash_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_monash,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
								// layer 4: Monash Caulfield
								let featureList_monash_caulfield = []
							    monash_caulfield_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_monash_caulfield.push(feature)
							    });
							    let geoJson_monash_caulfield = {
							        "type": "FeatureCollection",
							        "features": featureList_monash_caulfield
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "monash_caulfield_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_monash_caulfield,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
								// layer 4: Swinburne
								let featureList_swinburne = []
							    swinburne_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_swinburne.push(feature)
							    });
							    let geoJson_swinburne = {
							        "type": "FeatureCollection",
							        "features": featureList_swinburne
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "swinburne_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_swinburne,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
								// layer 5: Vic Uni
								let featureList_vic_uni = []
							    vic_uni_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_vic_uni.push(feature)
							    });
							    let geoJson_vic_uni = {
							        "type": "FeatureCollection",
							        "features": featureList_vic_uni
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "vic_uni_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_vic_uni,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
								// layer 6: Latrobe Uni
								let featureList_latrobe_uni = []
							    latrobe_uni_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_latrobe_uni.push(feature)
							    });
							    let geoJson_latrobe_uni = {
							        "type": "FeatureCollection",
							        "features": featureList_latrobe_uni
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "latrobe_uni_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_latrobe_uni,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
								// layer 7: Deakin Uni
								let featureList_deakin_uni = []
							    deakin_uni_data.rows.forEach(function(row){
							        var feature = {
							            "type": "Feature",
							            "geometry":{
							                "type": "Point",
							                "coordinates": row.key.coordinates
							            },
							            "properties":{
							                "user_id": row.key.user,
							                "text": row.key.text,
							                "sentiment": row.key.sentiment,
							                "created_at": row.key.created_at
							            }
							        }
							        featureList_deakin_uni.push(feature)
							    });
							    let geoJson_deakin_uni = {
							        "type": "FeatureCollection",
							        "features": featureList_deakin_uni
							    }
							    // plotting GeoJSON points on maps
							    map.on('load', function () {
							        map.addLayer({
							            "id": "deakin_uni_layer",
							            "type": "circle",
							            "source": {
							                "type": "geojson",
							                "data": geoJson_deakin_uni,
							            },
							            "paint":{
							                'circle-radius': {
							                    'base': 1.75,
							                    'stops': [[12, 2], [22, 20]]
							                },
							                'circle-color': {
							                    property: "sentiment",
							                    type: "interval",
							                    stops: sentimentList,
							                },
							                'circle-opacity': 0.7
							            }
							        });
							    });
//////////////////////////////////////////////////////////////////////////////////
							    // When a click event occurs near a place, open a popup at the location of
							    // the feature, with HTML description from its properties
							    map.on('click', function(e) {
							        var features = map.queryRenderedFeatures(e.point, { layers: ['unimelb_layer','rmit_layer' ] });

							        // if the features have no info, return nothing
							        if (!features.length) {
							            return;
							        }

							        var feature = features[0];

							        // Populate the popup and set its coordinates
							        // based on the feature found
							        var popup = new mapboxgl.Popup()
							            .setLngLat(feature.geometry.coordinates)
							            .setHTML(
							                '<div id="popup" class="popup" style="z-index: 10;"> <h5> Detail: </h5>' +
							                '<ul class="list-group">' +
							                '<li class="list-group-item"> Tweet     : ' + feature.properties['text'] + " </li>" +
							                '<li class="list-group-item"> User_ID   : ' + feature.properties['user_id'] + " </li>" +
							                '<li class="list-group-item"> Sentiment : ' + feature.properties['sentiment'] + " </li>" +
							                '<li class="list-group-item"> Time      : ' + feature.properties['created_at'] + " </li>" + '</ul> </div>')
							            .addTo(map);
							    });

							    // // Use the same approach as above to indicate that the symbols are clickable
							    // // by changing the cursor style to 'pointer'
							    map.on('mousemove', function(e) {
							        var features = map.queryRenderedFeatures(e.point, { layers: ['unimelb_layer'] });
							        map.getCanvas().style.cursor = 'pointer';
							    });
							});
						});
					});
				});
			});
		});
	});
});


</script>

</body>
</html>

<!-- Visualize different communities in Melbourne -->
<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Language Communities in Melbourne</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
    <script src="./js/jquery-3.2.1.min.js"></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>


<div id='map'></div>

<script>

let url = "http://***REMOVED***@115.146.87.112:5984/processed_tweet_db/_design/community-langs/_view/new-view?&reduce=false"
// Views:
// for_visualization: any tweet has point coordinates and polarity
// community-langs: any tweet has an assigned community_lang 


$.get(url, function(couchData){
    
    console.log(couchData);
    
    // access token to mapbox 
    mapboxgl.accessToken = 'pk.eyJ1IjoiYmRhbmcxIiwiYSI6ImNqMmVzOTl1bzA3c2oycWx2bXQ5d3BkYW0ifQ.eMCcDItwOxuOwjazCFCyZQ';
    
    // Define a map 
    var map = new mapboxgl.Map({
        container: 'map', // container id
        style: 'mapbox://styles/mapbox/dark-v9', //stylesheet location
        center: [144.98, -37.79], // starting position
        // pitch: 85,
        bearing: 5, 
        zoom: 11.5 // starting zoom
    });

    // Add zoom and rotation controls to the map.
    map.addControl(new mapboxgl.NavigationControl());

    // Add FullScreen view 
    map.addControl(new mapboxgl.FullscreenControl());

    let featureList = []

    couchData.rows.forEach(function(row){
        var feature = {
            "type": "Feature",
            "geometry":{
                "type": "Point",
                "coordinates": row.key.coordinates
            },
            "properties":{
                "text": row.key.text,
                "polarity": row.key.polarity,
                "community_lang": row.key.community_lang,
                "translation": row.key.translation, 
                "community": row.key.community,
                "created_at": row.key.created_at,
                "user": row.key.user
            }
        }
        featureList.push(feature)
    });

    let geoJson = {
        "type": "FeatureCollection",
        "features": featureList
    }


    // source: http://htmlcolorcodes.com/color-chart/
    var sentimentColor = [
        [-0.01, '#b71c1c'],
        [-0.75, '#d32f2f'],
        [-0.5, '#f44336'],
        [-0.25, '#e57373'],
        [0, '#b3e5fc'],
        [0.25, '#4fc3f7'],
        [0.5,'#03a9f4'],
        [0.75,'#0288d1'],
        [0.01,'#01579b' ]
    ];

    var communityColor = [
        ["ar", "#DC7633"], //2124
        // ["bg",], //1
        // ["ca",], //89
        // ["cs",], //45
        // ["cy",], //11
        ["da", "#edbb99"], //321
        ["de", "#FF0000"], //2100
        // ["el",], //100
        ["es","#800000"], //11429
        ["et", "#fad7a0"], //154
        // ["eu",], //1
        // ["fa",], //8
        ["fi","#a9dfbf"], //622
        // ["fil",], //22
        ["fr","#0000FF"], //12023
        // ["ga",], //1
        // ["gl",], //13
        // ["hi",], //46
        ["ht","#f5cba7"], //138
        // ["hu",], //84
        ["id","#800080"], //2512
        ["in","#800080"], //1484
        // ["is",], //11
        ["it","#000080"], //3506
        // ["iw",], //9
        ["ja","#FFFFFF"], //10176
        // ["kn",], //1
        ["ko","#D7BDE2"], //511
        // ["lo",], //15
        // ["lt",], //6
        // ["lv",], //35
        // ["mi",], //1
        // ["ml",], //7
        // ["msa",], //17
        // ["nb",], //2
        // ["ne",], //8
        ["nl","#808000"], //1153
        ["no", "#D4E6F1 "], //222
        // ["pa",], //2
        ["pl", "#FEF5E7"], //205
        ["pt","#00FF00"], //7695
        // ["pt-PT",], //1
        // ["ro",], //32
        ["ru","#FF00FF"], //2046
        // ["Select Language...",], //404
        // ["si",], //1
        // ["sk",], //18
        // ["sl",], //43
        // ["sr",], //5
        ["sv", "#F6DDCC"], //516
        // ["ta",], //2
        ["th","#808080"], //2369
        ["tl","#1ABC9C"], //522
        ["tr","#008080"], //1560
        // ["uk",], //3
        // ["vi",], //54
        ["xx-lc", "#C0C0C0"], //2553
        ["zh","#FFFF00"], //273
        ["zh-cn","#FFFF00"], //1067
        ["zh-CN","#FFFF00"], //92
        ["zh-Hans","#FFFF00"], //234
        ["zh-Hant","#FFFF00"], //15
        ["zh-HK","#FFFF00"], //75
        ["zh-tw","#FFFF00"], //514
        ["zh-TW","#FFFF00"], //28
    ]
    
    // plotting GeoJSON points on maps 
    map.on('load', function () {

        map.addLayer({
            "id": "communities",
            "type": "circle",
            "source": {
                "type": "geojson",
                "data": geoJson,
            },
            "paint":{
                'circle-radius': {
                    'base': 1.75,
                    'stops': [[12, 2], [22, 20]]
                },
                'circle-color': {
                    property: "community_lang",
                    type: "categorical",
                    stops: communityColor,
                },
                'circle-opacity': 0.7
            }
        });

     
    });
    // When a click event occurs near a place, open a popup at the location of
    // the feature, with HTML description from its properties
    map.on('click', function(e) {
        var features = map.queryRenderedFeatures(e.point, { layers: ['communities'] });

        // if the features have no info, return nothing
        if (!features.length) {
            return;
        }

        var feature = features[0];

        // Populate the popup and set its coordinates
        // based on the feature found
        var popup = new mapboxgl.Popup()
            .setLngLat(feature.geometry.coordinates)
            .setHTML(
                '<div id="popup" class="popup" style="z-index: 10;"> <h5> Detail: </h5>' +
                '<ul class="list-group">' +
                '<li class="list-group-item"> User        : ' + feature.properties['user'] + " </li>" +
                '<li class="list-group-item"> Tweet       : ' + feature.properties['text'] + " </li>" +
                '<li class="list-group-item"> Translation : ' + feature.properties['translation'] + " </li>" +
                '<li class="list-group-item"> Sentiment   : ' + feature.properties['polarity'] + " </li>" +
                '<li class="list-group-item"> Language    : ' + feature.properties['community_lang'] + " </li>" +
                '<li class="list-group-item"> Community   : ' + feature.properties['community'] + " </li>" + '</ul> </div>')
            .addTo(map);
    });

    // Use the same approach as above to indicate that the symbols are clickable
    // by changing the cursor style to 'pointer'
    map.on('mousemove', function(e) {
        var features = map.queryRenderedFeatures(e.point, {layers: ['communities']});
        map.getCanvas().style.cursor = 'pointer';
    });
});
</script>

</body>
</html>
